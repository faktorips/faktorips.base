<project name="Automated Eclipse Testing" default="all"  basedir="." >

	<!--properties file containing the plugin directory name including version number-->
	<property file="test.properties" />

	<!--properties file containing the build information-->
	<property file="label.properties" />
	
	<!--default directory where test-eclipse will be installed-->
	<property name="install" value="${basedir}/eclipse" />
	
	<!--suffix added to report name to identify which platform tests results come from-->
	<property name="platform" value="${os}.${ws}.${arch}" />

	<!-- The root of the eclipse installation -->
	<property name="eclipse-home" value="${install}" />

	<!-- The directory that will contain the xml and html results from the tests that are run -->
 	<property name="results" value="${basedir}/results" />
	
	<target name="init">
		<!--Unlock files on the Mac before starting tests.
		  Required to delete some workspace directories (org.eclipse.core.filebuffers.tests and Team CVS tests).-->
		<exec dir="${basedir}" executable="chflags" os="Mac OS X">
		  <arg line="-R nouchg ${install}"/>
		</exec>
		
		<condition property="runtimeArchive" value="eclipse-SDK-${buildId}-win32.zip">
			<and>
   				<equals arg1="${os}" arg2="win32" />
				<equals arg1="${ws}" arg2="win32" />
				<equals arg1="${arch}" arg2="x86" />				
			</and>
		</condition>
		<condition property="runtimeArchive" value="eclipse-SDK-${buildId}-linux-gtk.tar.gz">
			<and>
				<equals arg1="${os}" arg2="linux" />
				<equals arg1="${ws}" arg2="gtk" />
				<equals arg1="${arch}" arg2="x86" />				
			</and>
		</condition>
		<condition property="runtimeArchive" value="eclipse-SDK-${buildId}-linux-motif.tar.gz">
			<and>
				<equals arg1="${os}" arg2="linux" />
				<equals arg1="${ws}" arg2="motif" />
				<equals arg1="${arch}" arg2="x86" />				
			</and>
		</condition>
		<condition property="runtimeArchive" value="eclipse-SDK-${buildId}-linux-gtk-ppc.tar.gz">
			<and>
				<equals arg1="${os}" arg2="linux" />
				<equals arg1="${ws}" arg2="gtk" />
				<equals arg1="${arch}" arg2="ppc" />				
			</and>
		</condition>
		<condition property="runtimeArchive" value="eclipse-SDK-${buildId}-linux-gtk-x86_64.tar.gz">
			<and>
				<equals arg1="${os}" arg2="linux" />
				<equals arg1="${ws}" arg2="gtk" />
				<equals arg1="${arch}" arg2="ppc" />				
			</and>
		</condition>
		<condition property="runtimeArchive" value="eclipse-SDK-${buildId}-macosx-carbon.tar.gz">
			<and>
				<equals arg1="${os}" arg2="macosx" />
				<equals arg1="${ws}" arg2="carbon" />
				<equals arg1="${arch}" arg2="ppc" />				
			</and>
		</condition>
		<condition property="runtimeArchive" value="eclipse-SDK-${buildId}-hpux-motif.zip">
			<and>
				<equals arg1="${os}" arg2="hpux" />
				<equals arg1="${ws}" arg2="motif" />
				<equals arg1="${arch}" arg2="PA_RISC" />				
			</and>
		</condition>
		<condition property="runtimeArchive" value="eclipse-SDK-${buildId}-solaris-motif.zip">
			<and>
				<equals arg1="${os}" arg2="solaris" />
				<equals arg1="${ws}" arg2="motif" />
				<equals arg1="${arch}" arg2="sparc" />				
			</and>
		</condition>
		<condition property="runtimeArchive" value="eclipse-SDK-${buildId}-solaris-gtk.zip">
			<and>
				<equals arg1="${os}" arg2="solaris" />
				<equals arg1="${ws}" arg2="gtk" />
				<equals arg1="${arch}" arg2="sparc" />				
			</and>
		</condition>
		<condition property="runtimeArchive" value="eclipse-SDK-${buildId}-aix-motif.zip">
			<and>
				<equals arg1="${os}" arg2="aix" />
				<equals arg1="${ws}" arg2="motif" />
				<equals arg1="${arch}" arg2="ppc" />				
			</and>
		</condition>
	</target>

	<target name="setup" unless="noclean">
		<condition property="setupTarget" value="setup-zip">
   				<contains string="${runtimeArchive}" substring=".zip" />
		</condition>
		<condition property="setupTarget" value="setup-tar.gz">
   				<contains string="${runtimeArchive}" substring=".tar.gz" />
		</condition>
		<antcall target="${setupTarget}" />
	</target>
	

	<!--setup for tar.gz archives-->
	<target name="setup-tar.gz" description="Reinstall the test Eclipse installation if specified by user">
		<property name="currentDir" value="${basedir}"/>
		<delete dir="${install}" />
		<mkdir dir="${install}" />
   	    
		<echo message="extracting eclipse-test" />
	    <exec dir="." executable="unzip" failonerror="true">
	    		<arg line="-o -qq eclipse34-test.zip -d ${install}" />
	    </exec>
		<echo message="extracting faktorips-test feature" />	 
        <exec dir="." executable="unzip" failonerror="true" >
                    <arg line="-o -qq *faktorips*test*.zip " />
        </exec>
		<echo message="extracting faktorips-feature" />
        <exec dir="." executable="unzip" failonerror="true">
                    <arg line="-o -qq *faktorips*Test*.zip " />
         </exec>


	
  	</target>

	<target name="configureTeamTest">
		<!-- Fill in cvs repository information -->
		<replace file="${eclipse-home}/plugins/${org.eclipse.team.tests.cvs.core}/repository.properties" token="@user@" value="@cvs_user@"/>
		<replace file="${eclipse-home}/plugins/${org.eclipse.team.tests.cvs.core}/repository.properties" token="@password@" value="@cvs_password@"/>
		<replace file="${eclipse-home}/plugins/${org.eclipse.team.tests.cvs.core}/repository.properties" token="@host@" value="@cvs_host@"/>
		<replace file="${eclipse-home}/plugins/${org.eclipse.team.tests.cvs.core}/repository.properties" token="@root@" value="@cvs_root@"/>
	</target>
	
	<target name="junit" depends="setup">
		<ant antfile="${eclipse-home}/plugins/${testPlugin}/test.xml" dir="${eclipse-home}" />
		<copy file="${eclipse-home}/${report}.xml" tofile="${results}/xml/${report}_${platform}.xml" failonerror="false" />
		<antcall target="genHtml" />
	</target>

	<target name="performance" if="performance.target.present">
		<antcall target="setup" />
		<ant antfile="${eclipse-home}/plugins/${testPlugin}/test.xml" dir="${eclipse-home}" target="performance" />
		<copy file="${eclipse-home}/${report}.xml" tofile="${results}/xml/${report}_${platform}.xml" failonerror="false" />
		<antcall target="genHtml" />
	</target>

	<target name="runtests" depends="init">
		<condition property="performance.target.present" value="true">
			<isset property="${testPlugin}.has.performance.target"/>
		</condition>
		
		<!--override the value of this property with performance if the tests run on performance machine-->
		<property name="test.target" value="junit" />
		<antcall target="${test.target}"/>
	</target>

	<target name="ant" description="Runs the org.eclipse.ant.tests.core test.xml">
		<antcall target="runtests">
			<param name="testPlugin" value="${org.eclipse.ant.tests.core}" />
			<param name="report" value="org.eclipse.ant.tests.core" />
		</antcall>
	</target>

	<target name="antui" description="Runs the org.eclipse.ant.tests.ui test.xml">
		<antcall target="runtests">
			<param name="testPlugin" value="${org.eclipse.ant.tests.ui}" />
			<param name="report" value="org.eclipse.ant.tests.ui" />
		</antcall>
	</target>

	<target name="compare" description="Runs the org.eclipse.compare.tests test.xml">
		<antcall target="runtests">
			<param name="testPlugin" value="${org.eclipse.compare.tests}" />
			<param name="report" value="org.eclipse.compare.tests" />
		</antcall>
	</target>
		
	<target name="jcore" description="Runs the org.eclipse.core.tests.harness test.xml">
		<antcall target="runtests">
			<param name="testPlugin" value="${org.eclipse.core.tests.harness}" />
			<param name="report" value="org.eclipse.core.tests" />
		</antcall>
	</target>

	<target name="coreexpressions" description="Runs the org.eclipse.core.expressions.tests test.xml">
		<antcall target="runtests">
			<param name="testPlugin" value="${org.eclipse.core.expressions.tests}" />
			<param name="report" value="org.eclipse.core.expressions.tests" />
		</antcall>
	</target>
	
	<target name="ltkuirefactoringtests" description="Runs the org.eclipse.ltk.ui.refactoring.tests test.xml">
		<antcall target="runtests">
			<param name="testPlugin" value="${org.eclipse.ltk.ui.refactoring.tests}" />
			<param name="report" value="org.eclipse.ltk.ui.refactoring.tests" />
		</antcall>
	</target>
	
	<target name="ltkcorerefactoringtests" description="Runs the org.eclipse.ltk.core.refactoring.tests test.xml">
		<antcall target="runtests">
			<param name="testPlugin" value="${org.eclipse.ltk.core.refactoring.tests}" />
			<param name="report" value="org.eclipse.ltk.core.refactoring.tests" />
		</antcall>
	</target>
	
	<target name="text" description="Runs the org.eclipse.text.tests test.xml">
		<antcall target="runtests">
			<param name="testPlugin" value="${org.eclipse.text.tests}" />
			<param name="report" value="org.eclipse.text.tests" />
		</antcall>
	</target>
	<target name="jface" description="Runs the org.eclipse.jface.text.tests test.xml">
		<antcall target="runtests">
			<param name="testPlugin" value="${org.eclipse.jface.text.tests}" />
			<param name="report" value="org.eclipse.jface.text.tests" />
		</antcall>	
	</target>
	<target name="filebuffers" description="Runs the org.eclipse.core.filebuffers.tests test.xml">
		<antcall target="runtests">
			<param name="testPlugin" value="${org.eclipse.core.filebuffers.tests}" />
			<param name="report" value="org.eclipse.core.filebuffers.tests" />
		</antcall>	
	</target>
	<target name="jdttext" description="Runs the  org.eclipse.jdt.text.tests test.xml">
		<antcall target="runtests">
			<param name="testPlugin" value="${org.eclipse.jdt.text.tests}" />
			<param name="report" value="org.eclipse.jdt.text.tests" />
		</antcall>	
	</target>
	<target name="relEng" description="Runs the org.eclipse.releng.tests test.xml">
		<antcall target="runtests">
			<param name="testPlugin" value="${org.eclipse.releng.tests}" />
			<param name="report" value="org.eclipse.releng.tests" />
		</antcall>

		<move todir="${results}/chkpii" includeEmptyDirs="no" failonerror="false">
		    <fileset dir="${results}/chkpii"/>
		    <mapper type="glob" from="*" to="${platform}_*"/>
  		</move>
	</target>
	
	<target name="help" description="Runs the org.eclipse.help.tests test.xml">      
       		<antcall target="runtests" >
    	   		<param name="testPlugin" value="${org.eclipse.help.tests}" />
			<param name="report" value="org.eclipse.help.tests" />
       		</antcall>
	</target>
	
	<target name="jdtcorecompiler">
		<antcall target="runtests" >
			<param name="testPlugin" value="${org.eclipse.jdt.core.tests.compiler}" />
			<param name="report" value="org.eclipse.jdt.core.tests.compiler" />
		</antcall>
	</target>
	
   <target name="jdtcorebuilder">
		<antcall target="runtests" >
			<param name="testPlugin" value="${org.eclipse.jdt.core.tests.builder}" />
			<param name="report" value="org.eclipse.jdt.core.tests.builder" />
		</antcall>
	</target>

	<target name="jdtcoremodel">
		<antcall target="runtests" >
			<param name="testPlugin" value="${org.eclipse.jdt.core.tests.model}" />
			<param name="report" value="org.eclipse.jdt.core.tests.model" />
		</antcall>
	</target>

	<target name="jdtcoreperf">
		<antcall target="runtests" >
			<param name="testPlugin" value="${org.eclipse.jdt.core.tests.performance}" />
			<param name="report" value="org.eclipse.jdt.core.tests.performance" />
		</antcall>
	</target>
	
	<target name="jdtdebug" description="Runs the org.eclipse.jdt.debug.tests test.xml">
		<antcall target="runtests" >
			<param name="testPlugin" value="${org.eclipse.jdt.debug.tests}" />
			<param name="report" value="org.eclipse.jdt.debug.tests" />
		</antcall>
	</target>


	<target name="jdtui" description="Runs the org.eclipse.jdt.ui.tests test.xml">
		<antcall target="runtests" >
			<param name="testPlugin" value="${org.eclipse.jdt.ui.tests}" />
			<param name="report" value="org.eclipse.jdt.ui.tests" />
		</antcall>
	</target>

	<target name="stdbuilder" description="Runs the faktorips.devtools.stdbuilder.test test.xml">
		<antcall target="runtests" >
			<param name="testPlugin" value="${org.faktorips.devtools.stdbuilder.test}" />
			<param name="report" value="org.faktorips.devtools.stdbuilder.test" />
		</antcall>
	</target>


	<target name="core" description="Runs the faktorips.devtools.core.test test.xml">
                <antcall target="runtests" >
                        <param name="testPlugin" value="${org.faktorips.devtools.core.test}" />
                       <param name="report" value="org.faktorips.devtools.core.test" />
                </antcall>
        </target>


	<target name="jdtuirefactoring" description="Runs the org.eclipse.jdt.ui.tests.refactoring test.xml">
		<antcall target="runtests" >
			<param name="testPlugin" value="${org.eclipse.jdt.ui.tests.refactoring}" />
			<param name="report" value="org.eclipse.jdt.ui.tests.refactoring" />
		</antcall>
	</target>


	<target name="pdeui">
       		<antcall target="runtests" >
       			<param name="testPlugin" value="${org.eclipse.pde.ui.tests}" />
			<param name="report" value="org.eclipse.pde.ui.tests" />
       		</antcall>
 	</target>
	
	<target name="swt" description="Runs the org.eclipse.swt.tests test.xml">
       		<antcall target="runtests" >
       			<param name="testPlugin" value="${org.eclipse.swt.tests}" />
			<param name="report" value="org.eclipse.swt.tests" />
       		</antcall>
 	</target>


	<target name="teamcore" description="Runs the org.eclipse.team.tests.core test.xml">      
    		<antcall target="runtests" >
    	  		<param name="testPlugin" value="${org.eclipse.team.tests.core}" />
			<param name="report" value="org.eclipse.team.tests.core" />
    		</antcall>
	</target>

	<target name="teamcvs" description="Runs the org.eclipse.team.tests.cvs.core test.xml.  This test requires additional setup.  See documentation in org.eclipse.team.tests.cvs.core">
		<antcall target="runtests">
	  		<param name="testPlugin" value="${org.eclipse.team.tests.cvs.core}" />
			<param name="output-file" value="org.eclipse.team.tests.cvs.xml" />
			<param name="report" value="org.eclipse.team.tests.cvs" />
    		</antcall>
   	</target>


	<target name="ui" description="Runs the org.eclipse.ui.tests test.xml">
		<antcall target="runtests">
			<param name="testPlugin" value="${org.eclipse.ui.tests}" />
			<param name="report" value="org.eclipse.ui.tests" />
		</antcall>
	</target>

	<target name="uircp" description="Runs the org.eclipse.ui.tests.rcp test.xml">
		<antcall target="runtests">
			<param name="testPlugin" value="${org.eclipse.ui.tests.rcp}" />
			<param name="report" value="org.eclipse.ui.tests.rcp" />
		</antcall>
	</target>

	<target name="uieditors" description="Runs the org.eclipse.ui.editors.tests test.xml">
		<antcall target="runtests">
			<param name="testPlugin" value="${org.eclipse.ui.editors.tests}" />
			<param name="report" value="org.eclipse.ui.editors.tests" />
		</antcall>
	</target>
	
	<target name="uiworkbenchtexteditor" description="Runs the org.eclipse.ui.workbench.texteditor.tests test.xml">
		<antcall target="runtests">
			<param name="testPlugin" value="${org.eclipse.ui.workbench.texteditor.tests}" />
			<param name="report" value="org.eclipse.ui.workbench.texteditor.tests" />
		</antcall>
	</target>

	<target name="update" description="Runs the org.eclipse.update.tests.core test.xml">
	    <antcall target="runtests" >
			<param name="testPlugin" value="${org.eclipse.update.tests.core}" />
			<param name="report" value="org.eclipse.update.tests.core" />
      	</antcall>
	</target>


	<target name="all">
		<antcall target="core" />
		<antcall target="stdbuilder" />
	</target>
	
	<target name="all5.0">
		<antcall target="jdtcorebuilder" />
		<antcall target="jdtcorecompiler" />
		<antcall target="jdtcoremodel" />
	</target>

	<target name="genHtml" description="Generates HTML results with provided JUNIT.XSL provided">
		<style style="JUNIT.XSL" basedir="${results}/xml" destdir="${results}/html" />
	</target>

</project>
