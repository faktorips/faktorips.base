@Library('f10-jenkins-library@1.1_patches')
@Library('fips-jenkins-library@main')

pipeline {
    agent any

    tools {
        jdk 'JDK21'
        maven 'maven 3.9'
    }

    options {
        buildDiscarder(logRotator(daysToKeepStr: '14', numToKeepStr: '100'))
    }

    stages {
        stage('Build and Test') {

            environment {
                MAVEN_OPTS = '-Xmx4g'
                DISPLAY = ':0'
            }

            steps {
                script {
                    currentBuild.displayName = "#${env.BUILD_NUMBER}.${env.GIT_BRANCH}"
                    sh 'rm -rf $HOME/.m2/repository/.meta'
                    sh 'rm -rf $HOME/.m2/repository/.cache'
                    sh 'rm -rf $HOME/.m2/repository/p2'
                }

                withMaven(publisherStrategy: 'EXPLICIT') {
                    sh "mvn -U -V -fae -e clean install -f codequality-config"
                    sh "mvn -U -V -T 8 -fae -e clean install -DskipTests=true -Dmaven.skip.tests=true -pl :targets -am -Dtycho.localArtifacts=ignore"
                    sh "mvn -U -V -T 8 -fae -e clean deploy site checkstyle:checkstyle -Dtycho.localArtifacts=ignore"
                    sh "mvn -V -T 8 -fae -e site:stage -f maven"
                }
            }
        }
        stage('Dependency-Check') {
            steps {
                dir('runtime') {
                    withMaven(publisherStrategy: 'EXPLICIT') {
                        dependencyCheck outputFile: 'dependency-check-runtime-report.html'
                    }
                }
                dir('devtools/common') {
                    withMaven(publisherStrategy: 'EXPLICIT') {
                        dependencyCheck outputFile: 'dependency-check-devtools-report.html'
                    }
                }
                rtp parserName: 'HTML', nullAction: '1', stableText: """
                    <h2>Dependency-Check</h2>
                    <ul><li><a href='${env.BUILD_URL}artifact/dependency-check-runtime-report.html' target='_blank'>Dependency-Check Runtime Report</a></li>
                    <li><a href='${env.BUILD_URL}artifact/dependency-check-devtools-report.html' target='_blank'>Dependency-Check Devtools Common Report</a></li></ul>
                  """
            }
        }

        stage('Deploy Additional Artifacts') {
            steps {
                withMaven(publisherStrategy: 'EXPLICIT') {
                    uploadDocumentation project: 'faktorips-maven-plugin', folder: 'maven/faktorips-maven-plugin', legacyMode: true, legacyUser: 'jenkins-fips-legacy'
                    // SNAPSHOT versions should also publish to major.minor
                    uploadDocumentation project: 'schema/faktor-ips', folder: 'devtools/common/faktorips-schemas/src/main/resources', releasePattern: /(?<major>\d+)\.(?<minor>\d+)\.(\d+)(-SNAPSHOT)?/, legacyMode: true, legacyUser: 'jenkins-fips-legacy'
                }
            }
        }

        stage('Build Integrationtest'){
            steps {
                build quietPeriod: 10, job: 'FaktorIPS_Integrationtest'
            }
        }
    }

    post {
        always {
            junit testResults: "**/target/surefire-reports/*.xml", allowEmptyResults: true
            recordIssues enabledForFailure: true,
                    qualityGates: [[threshold: 1, type: 'NEW', unstable: true]],
                    tools: [java(), javaDoc(), spotBugs(), checkStyle(), eclipse()]
            jacoco sourceInclusionPattern: '**/*.java'
        }

        regression {
            sendFailureEmail()
        }
    }
}
